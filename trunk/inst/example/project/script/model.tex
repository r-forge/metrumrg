\input{settings.sty}
\usepackage{Sweave}

 
\begin{document}
\vspace*{2cm}
\begin{center}
{\Large Modeling}\\
~\\
\today\\
~\\
Tim Bergsma\\
\end{center}
\newpage

\section{Purpose}
This script runs NONMEM models and diagnostics for sample phase1 data.
\section{Model Development}
\subsection{Set up for NONMEM run.}
\begin{Schunk}
\begin{Sinput}
> #Be sure to set directory to the script directory that contains this file.
> library(metrumrg)
> #command <- '/opt/NONMEM/nm72/nmqual/autolog.pl'
> cat.cov='SEX'
> cont.cov=c('HEIGHT','WEIGHT','AGE')
> par.list=c('CL','Q','KA','V','V2','V3')
> eta.list=paste('ETA',1:10,sep='')
\end{Sinput}
\end{Schunk}
\subsection{Run NONMEM.}
\begin{Schunk}
\begin{Sinput}
> NONR72(
+      run=1001:1005,                       # 5 models, ctl pre-written
+      #command=command,                    # this version will search for NONMEM
+      project='../nonmem',                 # must specify, unless ctl in getwd()
+      grid=TRUE,                          # set to FALSE for better error messaging (but slower)
+      nice=TRUE,                           # don't delete subversioned directories
+      checkrunno=FALSE,                    # TRUE auto-replaces conflicting run numbers
+      cont.cov=cont.cov,                   # see help for following
+      cat.cov=cat.cov,
+      par.list=par.list,
+      eta.list=eta.list,
+      grp='SEX',                           # separate diagnostic plots for each level of SEX
+      grpnames=c('female','male'),         # use these instead of 0, 1, when plotting by SEX
+      include.all=TRUE,                    # also show diagnostics with groups combined
+      plotfile='../nonmem/*/*.pdf',        # use the run dir and run name for the plot file 
+      streams='../nonmem/ctl'              # expect the control streams here, not locally
+ )
\end{Sinput}
\begin{Soutput}
Installing SIGCHLD signal handler...Done.
\end{Soutput}
\begin{Sinput}
> progress(1001:1005,project='../nonmem')
\end{Sinput}
\begin{Soutput}
       queued      compiled       running          done indeterminate 
            4             0             0             1             0 
\end{Soutput}
\begin{Sinput}
> follow(1001:1005,project='../nonmem')
\end{Sinput}
\begin{Soutput}
       queued      compiled       running          done indeterminate 
            5             0             0             0             0 
       queued      compiled       running          done indeterminate 
            1             4             0             0             0 
       queued      compiled       running          done indeterminate 
            0             5             0             0             0 
       queued      compiled       running          done indeterminate 
            0             1             4             0             0 
       queued      compiled       running          done indeterminate 
            0             0             3             2             0 
       queued      compiled       running          done indeterminate 
            0             0             0             5             0 
\end{Soutput}
\begin{Sinput}
> Sys.sleep(10)                             #wait briefly to ensure all processes complete
\end{Sinput}
\end{Schunk}
Covariance succeeded on model 1005.
We confirm that we can get similar results with different initial estimates.
\begin{Schunk}
\begin{Sinput}
> getwd()
\end{Sinput}
\begin{Soutput}
[1] "/data/metrumrg/inst/example/project/script"
\end{Soutput}
\begin{Sinput}
> ctl <- read.nmctl('../nonmem/1005/1005.ctl',parse=TRUE)
> names(ctl)
\end{Sinput}
\begin{Soutput}
 [1] "prob"       "input"      "data"       "subroutine" "pk"        
 [6] "error"      "theta"      "omega"      "sigma"      "estimation"
[11] "cov"        "table"      "table"     
\end{Soutput}
\begin{Sinput}
> ctl$theta[] <- lapply(ctl$theta,`comment<-`,value=NULL)
> writeLines(format(ctl$theta))
\end{Sinput}
\begin{Soutput}
; 
(0,10,50)
(0,10,100)
(0,0.2,5)
(0,10,50)
(0,100,1000)
(0,1,2)
(0,0.75,3)
\end{Soutput}
\begin{Sinput}
> set.seed(0)
> ctl$theta <- tweak(ctl$theta)
> writeLines(format(ctl$theta))
\end{Sinput}
\begin{Soutput}
; 
(0,11.6,50)
(0,9.58,100)
(0,0.235,5)
(0,11.7,50)
(0,105,1000)
(0,0.8,2)
(0,0.659,3)
\end{Soutput}
\begin{Sinput}
> ctl$prob
\end{Sinput}
\begin{Soutput}
[1] "1005 phase1 2 CMT like 1004 but diff. initial on V3"
\end{Soutput}
\begin{Sinput}
> ctl$prob <- '1006 like 1005 with tweaked initial estimates'
\end{Sinput}
\end{Schunk}
We request some variants of PRED and CWRES. 
\begin{Schunk}
\begin{Sinput}
> ctl[[12]]
\end{Sinput}
\begin{Soutput}
[1] "NOPRINT FILE=./1005.tab ONEHEADER ID AMT TIME EVID PRED IPRE CWRES"
\end{Soutput}
\begin{Sinput}
> preds <- c('NPRED','CPRED','CPREDI','EPRED')
> res <- c('RES','NRES','NWRES','CRES','RESI','WRESI','CRESI','CWRESI','ERES','EWRES','ECWRES')
> ctl[[12]] <- c(ctl[[12]],preds, res)
\end{Sinput}
\end{Schunk}
\begin{Schunk}
\begin{Sinput}
> write.nmctl(ctl,file='../nonmem/ctl/1006.ctl')
> NONR72(
+      run=1006,
+      project='../nonmem',
+      grid=TRUE,
+      nice=TRUE,
+      mode='para',                         # For illustrative purposes, we parallelize this run.
+      pe='orte 16',                        # orte is the parallelization environment; we use 16 cores.
+      checkrunno=TRUE,                     # default
+      diag=TRUE,                           # default
+      streams='../nonmem/ctl',             # software will look for 1006.pmn or template.pmn
+      plotfile='../nonmem/*/*.pdf'
+ )
> Sys.sleep(5)
> qstat()
> follow(1006,project='../nonmem')